<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .states {
            fill: none;
            stroke: #000000;
            stroke-linejoin: round;
        }

        .d3-tip {
            line-height: 1;
            padding: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
        }

        /* Style northward tooltips specifically */
        .d3-tip.n:after {
            margin: -2px 0 0 0;
            top: 100%;
            left: 0;
        }

    </style>
    <script src="lib/d3.v5.min.js"></script>
    <script src="lib/d3-scale-chromatic.v1.min.js"></script>
    <script src="lib/topojson.v2.min.js"></script>
    <script src="lib/d3-simple-slider.min.js"></script>
    <script src="lib/d3-tip.min.js"></script>
</head>
<body>
<div style="background-color:bisque;color: brown; font-family:'Book Antiqua' ;text-align: center"><h1>Impact of Climate on Health</h1></div>
<div style="overflow: hidden">
    <div style="float: left" id="slider-percep"></div>
    <div style="float: left" id="slider-temp"></div>
    <div style="overflow: hidden" id="slider-pollution"></div>
    <div style="float: left" id="slider-storm"></div>
    <div style="float: left" id="slider-flu"></div>
    <div style="float: left" id="slider-lung"></div>
</div>
<svg width="1500" height="800"></svg>
<script>
    var margin = {top: 50, right: 200, bottom: 50, left: 70};

    var dataset, mapJson, currentYear = "2010";

    var svg = d3.select("svg"),
        width = +svg.attr("width") - margin.left - margin.right - 150,
        height = +svg.attr("height") - margin.top - margin.bottom - 100;

    var airfludataMap = d3.map();

    var projection = d3.geoAlbersUsa()
        .translate([width / 2, height / 2])
        .scale([1000]);
    var path = d3.geoPath().projection(projection);


    var x = d3.scaleLinear()
        .rangeRound([0, width]);

    var color;

    svg.append("text")
        .attr("x", width - 200)
        .attr("y", margin.top)
        .style("font-size", "13px")
        .style("font-weight", "bold")
        .attr("text-achor", "middle")
        .text("Index");


    var tool_tip = d3.tip()
        .attr("class", "d3-tip")
        .offset([-8, 0])
        .html(function (d) {
            var state = d.properties.name;
            var entry = dataset.find(function (s) {
                if (d.properties.name.toUpperCase() == s.state.toUpperCase()) return s.Region;
            });
            var region = entry.Region;
            var eqCount = entry[currentYear]
            return "State: " + state + "<br />"
                + "Region: " + region + "<br />"
                + "Year: " + currentYear + "<br />"
                + "Earthquakes: " + eqCount;
        });
    svg.call(tool_tip);

    var promises = [
        d3.json("states-10m.json")
            .then(function (json) {
                mapJson = json;
            }),
        d3.dsv(',', "data/final_merged.csv")
            .then(function (d) {
                dataset = d;
                d.forEach(function (r) {
                    airfludataMap.set(r.state.toUpperCase(), r["inches of water"]);
                });
            })
    ];

    Promise.all(promises).then(ready);

    function ready() {
        loadMapUsingData();
        showSliders()
    }

    function loadMapUsingData() {
        color = d3.scaleQuantile()
            .domain(airfludataMap.values().filter(function (d, i) {
                return airfludataMap.values().indexOf(d) == i;
            }))
            .range(d3.schemeOrRd[9]);
        svg.append("g")
            .attr("class", "states")
            .selectAll("path")
            .data(topojson.feature(mapJson, mapJson.objects.states).features)
            .enter().append("path")
            .attr("fill", function (d) {
                return color(d.eqmag = airfludataMap.get(d.properties.name.toUpperCase()));
            })
            .attr("d", path)
            .on('mouseover', tool_tip.show)
            .on('mouseout', tool_tip.hide)
            .append("title");

        svg.append("path")
            .datum(topojson.mesh(mapJson, mapJson.objects.states, function (a, b) {
                return a !== b;
            }))
            .attr("class", "states")
            .attr("d", path)
        ;

        createLegend();
    }

    function showSliders() {
        showSlider("inches of water", 'div#slider-percep', "Precipitation",
                            1, 300, 10);
        showSlider("degrees F", 'div#slider-temp', "Temperature",
                            1, 300, 40);
        showSlider("average_AQI", 'div#slider-pollution', "Pollution Index",
                            1, 200, 1);
        showSlider("storm_deaths", 'div#slider-storm', "Storm Deaths",
                            1, 200, 1);
        showSlider("Pneumonia and Influenza Deaths", 'div#slider-flu', "Pneumonea/Flu Deaths",
                            1, 200, 1);
        showSlider("lung_cancer", 'div#slider-lung', "Lung Cancer Deaths",
                            1, 200, 1);


    }

    function showSlider(column, divName, title, step, width, def) {
        var slider = d3
            .sliderBottom()
            .min(d3.min(dataset, function (d) {
                return +d[column]
            }))
            .max(d3.max(dataset, function (d) {
                return +d[column]
            }))
            .step(step)
            .width(width)
            .default(def);
        // .on('onchange', val => {
        //     currentYear = d3.timeFormat('%Y')(val);
        //     updateMap(val);
        // });


        var gSvg = d3
            .select(divName)
            .append('svg')
            .attr('width', width + 100)
            .attr('height', 100);

        gSvg.append('text')
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("x", 30)
            .attr("y", margin.top - 30)
            .text(title);

        var g = gSvg
            .append('g')
            .attr('transform', 'translate(80,30)');
        g.call(slider);
    }

    function updateMap(val) {
        airfludataMap = d3.map();
        var year = d3.timeFormat('%Y')(val);
        dataset.forEach(function (r) {
            airfludataMap.set(r.state, r["inches of water"]);
        });
        loadMapUsingData(mapJson);
    }

    function createLegend() {
        d3.selectAll(".legend").remove();

        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("x", width - 200)
            .attr("y", margin.top + 30)
            .attr("height", 100)
            .attr("width", 150);
        legend.selectAll('g').data(color.range())
            .enter()
            .append('g')
            .each(function (c, i) {
                var g = d3.select(this);
                g.append("rect")
                    .attr("x", width - 150)
                    .attr("y", i * 22 + 70)
                    .attr("width", 20)
                    .attr("height", 20)
                    .attr("fill", c);

                g.append("text")
                    .attr("x", width - 125)
                    .attr("y", i * 23 + 80)
                    .attr("height", 20)
                    .attr("width", 100)

                    .style("font-size", "12px")
                    .text(Math.round(color.invertExtent(c)[1]));

            });

    }
</script>
</body>
</html>