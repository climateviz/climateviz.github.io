<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .states {
            fill: none;
            stroke: #000000;
            stroke-linejoin: round;
        }

        .d3-tip {
            line-height: 1;
            padding: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
        }

        /* Style northward tooltips specifically */
        .d3-tip.n:after {
            margin: -2px 0 0 0;
            top: 100%;
            left: 0;
        }

    </style>
    <script src="lib/d3.v5.min.js"></script>
    <script src="lib/d3-scale-chromatic.v1.min.js"></script>
    <script src="lib/topojson.v2.min.js"></script>
    <script src="lib/d3-simple-slider.min.js"></script>
    <script src="lib/d3-tip.min.js"></script>

    <script src="lib/emlapack-custom.js"></script>
    <script src="lib/index.js"></script>
    <script src="lib/pca.js"></script>
    <script src="lib/renderer.js"></script>
    <script src="radarChart.js" charset="utf-8"></script>

</head>
<body>
<div style="background-color:bisque;color: brown; font-family:'Book Antiqua' ;text-align: center"><h1>Impact of Climate
    on Health</h1></div>
<div style="overflow: hidden">
    <div style="float: left;height: 70px">
        <input type="checkbox" checked id="percepId" onchange="updateMap()" style="float:left; position: relative;top:10px">
        <div style="float: left" id="slider-percep"></div>
    </div>
    <div style="float: left;height: 70px">
        <input type="checkbox" checked  id="tempId" onchange="updateMap()" style="float:left; position: relative;top:10px">
        <div style="float: left" id="slider-temp"></div>
    </div>
    <div style="float: left;height: 70px">
        <input type="checkbox" checked  id="pollutionId" onchange="updateMap()" style="float:left; position: relative;top:10px">
        <div style="overflow: hidden" id="slider-pollution"></div>
    </div>
    <div style="float: left;height: 70px">
        <input type="checkbox" checked  id="stormId" onchange="updateMap()" style="float:left; position: relative;top:10px">
        <div style="float: left" id="slider-storm"></div>
    </div>
    <div style="float: left;height: 70px">
        <input type="checkbox" checked  id="stormInjId" onchange="updateMap()" style="float:left; position: relative;top:10px">
        <div style="float: left" id="slider-storm-inj"></div>
    </div>
    <div style="float: left;height: 70px">
        <input type="checkbox" id="fluId" onchange="updateMap()" style="float:left; position: relative;top:10px">
        <div style="float: left" id="slider-flu"></div>
    </div>
    <div style="float: left;height: 70px">
        <input type="checkbox" id="lungId" style="float:left; position: relative;top:10px">
        <div style="float: left" id="slider-lung"></div>
    </div>
</div>
<svg width="1500" height="800"></svg>

<div class="radarChart2" style="display: inline-flex;"></div>

<script>


    //Data format for the radar chart
    // var data = [
	// 			{ name: 'New Mexico',
	// 				axes: [
	// 					{axis: 'Precipitation', value: 42},
	// 					{axis: 'Temperature', value: 20},
	// 					{axis: 'Pollution Index', value: 60},
	// 					{axis: 'Storm Deaths', value: 26},
	// 					{axis: 'Storm Injuries', value: 35},
    //                     {axis: 'Pneumonea/Flu Deaths', value: 20},
    //                     {axis: 'Lung Cancer Deaths', value: 20}


	// 				],
    //      color: '#26AF32'
	// 			},
	// 			{ name: 'Illinois',
	// 				axes: [
	// 					{axis: 'Precipitation', value: 50},
	// 					{axis: 'Temperature', value: 45},
	// 					{axis: 'Pollution Index', value: 20},
	// 					{axis: 'Storm Deaths', value: 20},
	// 					{axis: 'Storm Injuries', value: 25},
    //                     {axis: 'Pneumonea/Flu Deaths', value: 20},
    //                     {axis: 'Lung Cancer Deaths', value: 20}	],
    //      color: '#762712'
	// 			},
    //     { name: 'Georgia',
	// 				axes: [
	// 					{axis: 'Precipitation', value: 32},
	// 					{axis: 'Temperature', value: 62},
	// 					{axis: 'Pollution Index', value: 35},
	// 					{axis: 'Storm Deaths', value: 10},
	// 					{axis: 'Storm Injuries', value: 20},
    //                     {axis: 'Pneumonea/Flu Deaths', value: 20},
    //                     {axis: 'Lung Cancer Deaths', value: 20}		],
    //      color: '#2a2fd4'
	// 			}
    // 		];
        // var radarChartOptions2 = {
        //             w: 290,
        //             h: 350,
        //             margin: margin,
        //             maxValue: 60,
        //             levels: 6,
        //             roundStrokes: false,
        //             color: d3.scaleOrdinal().range(["#AFC52F", "#ff6600", "#2a2fd4"]),
        //             format: '.0f',
        //             legend: { title: 'States', translateX: 100, translateY: 40 },
        //             unit: '%'
        //         };

        //         // Draw the chart, get a reference the created svg element :
        // let svg_radar2 = RadarChart(".radarChart2", data, radarChartOptions2);

    var margin = {top: 50, right: 200, bottom: 50, left: 70};
    var sliderPercep, sliderTemp, sliderPollution, sliderStorm ,sliderStormInj, sliderFlu, sliderLung;
    var dataset, mapJson, currentYear = "2010";

    var svg = d3.select("svg"),
        width = +svg.attr("width") - margin.left - margin.right - 150,
        height = +svg.attr("height") - margin.top - margin.bottom - 100;

    var dataMap = d3.map();

    var projection = d3.geoAlbersUsa()
        .translate([width / 2, height / 2])
        .scale([1000]);
    var path = d3.geoPath().projection(projection);


    var x = d3.scaleLinear()
        .rangeRound([0, width]);

    var color;

    svg.append("text")
        .attr("x", width - 200)
        .attr("y", margin.top)
        .style("font-size", "13px")
        .style("font-weight", "bold")
        .attr("text-achor", "middle")
        .text("Index");


    var tool_tip = d3.tip()
        .attr("class", "d3-tip")
        .offset([-8, 0])
        .html(function (d) {
            var state = d.properties.name;
            var entry = dataset.find(function (s) {
                if (d.properties.name.toUpperCase() == s.state.toUpperCase()) return s.Region;
            });
            var region = entry.Region;
            var eqCount = entry[currentYear]
            return "State: " + state + "<br />"
                + "Region: " + region + "<br />"
                + "Year: " + currentYear + "<br />"
                + "Earthquakes: " + eqCount;
        });
    svg.call(tool_tip);



    var promises = [
        d3.json("states-10m.json")
            .then(function (json) {
                mapJson = json;
            }),
        d3.dsv(',', "data/final_merged.csv")
            .then(function (d) {
                dataset = d;
                d.forEach(function (r) {
                    dataMap.set(r.state.toUpperCase(), calculateIndex(r));
                });
            })
    ];

    Promise.all(promises).then(ready);

    function calculateIndex(r) {
        var percep = r['inches of water'];
        var temp = r['degrees F'];
        var pollution = r['average_AQI'];
        var stormDeaths = r['storm_deaths'];
        var stormInj = r['storm_injuries'];
        var flu = r['Pneumonia and Influenza Deaths'];
        var lung = r['lung_cancer'];

        var inclVals = [];
        if (document.getElementById("percepId").checked)
            inclVals.push(percep);
        if (document.getElementById("tempId").checked)
            inclVals.push(temp);
        if (document.getElementById("pollutionId").checked)
            inclVals.push(pollution);
        if (document.getElementById("stormId").checked)
            inclVals.push(stormDeaths);
        if (document.getElementById("stormInjId").checked)
            inclVals.push(stormInj);
        if (document.getElementById("fluId").checked)
            inclVals.push(flu);
        if (document.getElementById("lungId").checked)
            inclVals.push(lung);

        return d3.mean(inclVals);
    }

    function calculatePCA() {

    }

    function ready() {
        loadMapUsingData();
        showSliders()
    }

    function loadMapUsingData() {
        color = d3.scaleQuantile()
            .domain(dataMap.values().filter(function (d, i) {
                return dataMap.values().indexOf(d) == i;
            }))
            .range(d3.schemeOrRd[9]);
        svg.append("g")
            .attr("class", "states")
            .selectAll("path")
            .data(topojson.feature(mapJson, mapJson.objects.states).features)
            .enter().append("path")
            .attr("fill", function (d) {
                return color(d.eqmag = dataMap.get(d.properties.name.toUpperCase()));
            })
            .attr("d", path)
            .on('mouseover', tool_tip.show)
            .on('mouseout', tool_tip.hide)
            .append("title");

        svg.append("path")
            .datum(topojson.mesh(mapJson, mapJson.objects.states, function (a, b) {
                return a !== b;
            }))
            .attr("class", "states")
            .attr("d", path)
        ;

        createLegend();
    }

    function showSliders() {
        sliderPercep = showSlider("inches of water", 'div#slider-percep', "Precipitation", "percepId",
            1, 200, 10);
        sliderTemp = showSlider("degrees F", 'div#slider-temp', "Temperature", "tempId",
            1, 200, 40);
        sliderPollution = showSlider("average_AQI", 'div#slider-pollution', "Pollution Index", "polluteId",
            1, 200, 1);
        sliderStorm = showSlider("storm_deaths", 'div#slider-storm', "Storm Deaths", "stormId",
            1, 200, 1);
        sliderStormInj = showSlider("storm_injuries", 'div#slider-storm-inj', "Storm Injuries", "stormInjId",
            1, 200, 1);
        sliderFlu = showSlider("Pneumonia and Influenza Deaths", 'div#slider-flu', "Pneumonea/Flu Deaths", "fluId",
            1, 200, 1);
        sliderLung = showSlider("lung_cancer", 'div#slider-lung', "Lung Cancer Deaths", "lungId",
            1, 200, 1);


    }

    function showSlider(column, divName, title, id, step, width, def) {
        var slider = d3
            .sliderBottom()
            .min(d3.min(dataset, function (d) {
                return +d[column]
            }))
            .max(d3.max(dataset, function (d) {
                return +d[column]
            }))
            .step(step)
            .width(width)
            .default(d3.mean(dataset, function (d) {
                return +d[column]
            }))
        .on('onchange', val => {
            updateMap();
        });


        var gSvg = d3
            .select(divName)
            .append('svg')
            .attr('width', width + 100)
            .attr('height', 100);


        gSvg.append('text')
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("x", 10)
            .attr("y", margin.top - 30)
            .text(title);

        var g = gSvg
            .append('g')
            .attr('transform', 'translate(30,30)');
        g.call(slider);

        return slider;
    }

    function updateMap() {
        dataMap = d3.map();
        dataset.forEach(function (r) {
            dataMap.set(r.state.toUpperCase(), calculateIndex(r));
        });
        loadMapUsingData(mapJson);
    }

    function createLegend() {
        d3.selectAll(".legend").remove();

        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("x", width - 200)
            .attr("y", margin.top + 30)
            .attr("height", 100)
            .attr("width", 150);
        legend.selectAll('g').data(color.range())
            .enter()
            .append('g')
            .each(function (c, i) {
                var g = d3.select(this);
                g.append("rect")
                    .attr("x", width - 150)
                    .attr("y", i * 22 + 70)
                    .attr("width", 20)
                    .attr("height", 20)
                    .attr("fill", c);

                g.append("text")
                    .attr("x", width - 125)
                    .attr("y", i * 23 + 80)
                    .attr("height", 20)
                    .attr("width", 100)

                    .style("font-size", "12px")
                    .text(Math.round(color.invertExtent(c)[1]));

            });

    }
</script>
</body>
</html>